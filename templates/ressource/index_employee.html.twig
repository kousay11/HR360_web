{% extends 'baseEMP.html.twig' %}

{% block title %}Liste des Ressources{% endblock %}

{% block css %}
  {{ parent() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ asset('front/css/project-card.css')}}" rel="stylesheet" >
  <style>
    #searchInput, #typeFilter, #priceRange, #availableFilter, #sortPrice {
        margin-bottom: 1rem;
    }
  </style>
{% endblock %}

{% block index %}
<section id="portfolio" class="portfolio section">
    <div class="container section-title" data-aos="fade-up">
        <h2>Nos Ressources</h2>
        <p>Découvrez toutes nos ressources disponibles</p>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="Rechercher une ressource...">
            </div>
            <div class="col-md-4">
                <select id="typeFilter" class="form-select">
                    <option value="">Toutes les catégories</option>
                    {% set displayedTypes = [] %}
                    {% for ressource in ressources %}
                        {% if ressource.type not in displayedTypes %}
                            <option value="{{ ressource.type }}">{{ ressource.type }}</option>
                            {% set displayedTypes = displayedTypes|merge([ressource.type]) %}
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="priceRange" class="form-label">Prix max</label>
                <input type="range" class="form-range" id="priceRange" min="0" max="5000" step="50" value="5000">
                <div id="priceValue">Prix max: 5000</div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label class="form-check-label" for="availableFilter">
                    <input type="checkbox" class="form-check-input" id="availableFilter">
                    Afficher uniquement disponibles
                </label>
            </div>
            <div class="col-md-6">
                <select id="sortPrice" class="form-select">
                    <option value="asc">Prix croissant</option>
                    <option value="desc">Prix décroissant</option>
                </select>
            </div>
        </div>

        <div class="row ressources-grid g-4">
            {% for ressource in ressources %}
                <div class="col-12 col-sm-6 col-xl-4 mb-4 ressource-card"
                     data-nom="{{ ressource.nom|lower }}"
                     data-type="{{ ressource.type }}">
                    <div class="card entity-card h-100">
                        <div class="image-container">
                            {% if ressource.image %}
                                <img src="{{ asset('uploads/images/' ~ ressource.image) }}"
                                     class="card-img-top"
                                     alt="{{ ressource.nom }}"
                                     style="height: 200px; object-fit: cover; border-radius: 0 !important;">
                            {% else %}
                                <div class="card-img-top d-flex align-items-center justify-content-center bg-light"
                                     style="height: 200px; border-radius: 0 !important;">
                                    <i class="bi bi-image fs-1 text-muted"></i>
                                </div>
                            {% endif %}
                        </div>

                        <div class="card-header entity-header">
                            <i class="fas fa-pc entity-icon"></i>
                            <h5 class="entity-title">{{ ressource.nom }}</h5>
                            <span class="badge bg-{{ ressource.etat == 'Disponible' ? 'success' : 'danger' }} badge-position">
                                <i class="fas fa-{{ ressource.etat == 'Disponible' ? 'check-circle' : 'times-circle' }} me-1"></i>
                                {{ ressource.etat }}
                            </span>
                        </div>

                        <div class="card-body entity-body">
                            <hr>
                            <div class="project-meta">
                                <i class="fas fa-tag"></i>
                                <span>Type: {{ ressource.type }}</span>
                            </div>
                            <div class="project-meta">
                                <i class="fas fa-euro-sign"></i>
                                <span>Prix: {{ ressource.prix|number_format(3, '.', ' ') }}</span>
                            </div>

                            {% set qrPath = 'uploads/qrcodes/qr_ressource_' ~ ressource.id ~ '.png' %}
                            {% if file_exists(qrPath) %}
                            <div class="text-center mt-3">
                                <button type="button"
                                        class="btn btn-sm btn-info w-100"
                                        data-bs-toggle="modal"
                                        data-bs-target="#qrModal{{ ressource.id }}">
                                    <i class="fas fa-qrcode me-2"></i>Voir QR Code
                                </button>

                                <div class="modal fade"
                                     id="qrModal{{ ressource.id }}"
                                     tabindex="-1"
                                     aria-labelledby="qrModalLabel{{ ressource.id }}"
                                     aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header bg-light">
                                                <h5 class="modal-title fs-5" id="qrModalLabel{{ ressource.id }}">
                                                    <i class="fas fa-qrcode me-2"></i>{{ ressource.nom }}
                                                </h5>
                                                <button type="button"
                                                        class="btn-close"
                                                        data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body text-center p-4">
                                                <div class="d-flex justify-content-center">
                                                    <img src="{{ asset(qrPath) }}"
                                                         class="img-fluid rounded shadow-sm"
                                                         alt="QR Code {{ ressource.nom }}"
                                                         style="max-width: 400px; width: 100%;">
                                                </div>
                                            </div>
                                            <div class="modal-footer bg-light">
                                                <button type="button"
                                                        class="btn btn-primary"
                                                        data-bs-dismiss="modal">
                                                    <i class="fas fa-times me-2"></i>Fermer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="card-footer entity-footer">
                            <a href="{{ ressource.etat == 'Disponible' ? path('app_reservation_new', {'ressourceId': ressource.id}) : '#' }}"
                               class="btn btn-outline-primary btn-sm {{ ressource.etat != 'Disponible' ? 'disabled' : '' }}"
                               {% if ressource.etat != 'Disponible' %}
                                   aria-disabled="true"
                                   data-bs-toggle="tooltip"
                                   title="Ressource indisponible"
                               {% endif %}>
                                <i class="fas fa-calendar-plus me-1"></i>
                                Réserver
                            </a>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="empty-state col-12">
                    <i class="bi bi-inboxes"></i>
                    <h3>Aucune ressource disponible</h3>
                    <p>Veuillez vérifier ultérieurement</p>
                </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endblock %}

{% block js %}
  {{ parent() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(t => new bootstrap.Tooltip(t));

        if (typeof AOS !== 'undefined') {
            AOS.init({
                duration: 800,
                easing: 'ease-out-quad',
                once: true,
                offset: 50
            });
        }

        const searchInput = document.getElementById('searchInput');
        const typeFilter = document.getElementById('typeFilter');
        const priceRange = document.getElementById('priceRange');
        const priceValue = document.getElementById('priceValue');
        const availableFilter = document.getElementById('availableFilter');
        const sortPrice = document.getElementById('sortPrice');
        const cards = document.querySelectorAll('.ressource-card');

        priceRange.addEventListener('input', function () {
            priceValue.textContent = `Prix max: ${priceRange.value}`;
            filterResources();
        });

        searchInput.addEventListener('input', filterResources);
        typeFilter.addEventListener('change', filterResources);
        availableFilter.addEventListener('change', filterResources);
        sortPrice.addEventListener('change', filterResources);

        function filterResources() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedType = typeFilter.value;
            const maxPrice = priceRange.value;
            const order = sortPrice.value;
            const isAvailableOnly = availableFilter.checked;

            cards.forEach(card => {
                const name = card.dataset.nom;
                const type = card.dataset.type;
                const price = parseFloat(card.querySelector('.project-meta span').textContent.replace('Prix: ', '').replace(' ', '').replace('€', ''));
                const isAvailable = card.querySelector('.badge').textContent === 'Disponible';

                let match = true;

                if (searchTerm && !name.includes(searchTerm)) {
                    match = false;
                }
                if (selectedType && type !== selectedType) {
                    match = false;
                }
                if (price > maxPrice) {
                    match = false;
                }
                if (isAvailableOnly && !isAvailable) {
                    match = false;
                }

                if (match) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        filterResources(); // Initial filter
    });
  </script>
{% endblock %}
